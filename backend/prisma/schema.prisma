datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  AUTHOR
  READER
}

enum StoryStatus {
  ONGOING
  COMPLETED
  HIATUS
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String
  role          Role      @default(READER)
  createdAt     DateTime  @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  authoredStories   Story[]  @relation("AuthorOfStories")
  bookmarks         Bookmark[]
  progresses        UserStoryProgress[]
  // comments       Comment[] // Có thể thêm sau này
}

model Story {
  id                String      @id @default(uuid())
  title             String
  slug              String      @unique
  description       String?     // Nên có thêm mô tả ngắn cho truyện
  cover_image_url   String?
  status            StoryStatus @default(ONGOING) // Trạng thái truyện
  view_count        Int         @default(0)       // Đếm tổng lượt xem
  
  author_id         String
  author            User        @relation("AuthorOfStories", fields: [author_id], references: [id])
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  chapters          Chapter[]
  bookmarks         Bookmark[]
  progresses        UserStoryProgress[]
  // genres         Genre[]  // Nên thêm quan hệ Many-to-Many với bảng Genre
}

model Chapter {
  id          String   @id @default(uuid())
  title       String
  // QUAN TRỌNG: Đổi content_url thành content để lưu text trực tiếp
  content     String   @db.Text // @db.Text để đảm bảo PostgreSQL dùng kiểu dữ liệu TEXT không giới hạn độ dài
  order       Int      // Để sắp xếp chương (ví dụ: chương 1 có order = 1)
  published   Boolean  @default(true) // Cho phép soạn nháp trước khi đăng
  view_count  Int      @default(0)

  story_id    String
  story       Story    @relation(fields: [story_id], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Đảm bảo mỗi truyện không có 2 chương cùng số thứ tự
  @@unique([story_id, order])
}

model Bookmark {
  user_id  String
  story_id String
  createdAt DateTime @default(now())

  user    User   @relation(fields: [user_id], references: [id])
  story   Story  @relation(fields: [story_id], references: [id])

  @@id([user_id, story_id])
}

model UserStoryProgress {
  user_id              String
  story_id             String
  last_read_chapter_id String
  updatedAt            DateTime @updatedAt // Biết được đọc lần cuối khi nào

  user    User   @relation(fields: [user_id], references: [id])
  story   Story  @relation(fields: [story_id], references: [id])

  @@id([user_id, story_id])
}